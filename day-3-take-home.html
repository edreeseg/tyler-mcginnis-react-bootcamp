<!DOCTYPE html>
<html>
<head>
<title>Popular Repos</title>
<script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
<script src='https://unpkg.com/babel-standalone@6/babel.min.js'></script>
</head>
<body>
<div id='app'></div>
<script>
    window.API = {
    fetchPopularRepos(language) {
        // "language" can be "javascript", "ruby", "python", or "all"
        const encodedURI = encodeURI(`https://api.github.com/search/repositories?q=stars:>1+language:${language}&sort=stars&order=desc&type=Repositories`)
        return fetch(encodedURI)
        .then((data) => data.json())
        .then((repos) => repos.items)
        .catch((error) => {
            console.warn(error)
            return null
        });
    }
    }
</script>

<script type='text/babel'>
    class Loading extends React.Component {
    constructor(props) {
        super(props);
        this.state = {
        text: 'Loading'
        };
    }
    componentDidMount() {
        const stopper = this.state.text + '...';
        this.interval = window.setInterval(() => {
        this.state.text === stopper
            ? this.setState(() => ({ text: 'Loading' }))
            : this.setState((prevState) => ({ text: prevState.text + '.' }))
        }, 300)
    }
    componentWillUnmount() {
        window.clearInterval(this.interval);
    }
    render() {
        return (
        <p>
            {this.state.text}
        </p>
        )
    }
    }

    class App extends React.Component {
    constructor(props){
        super(props);
        this.state = {
            loading: true,
            repos: [],
        };
        this.handleLanguageChange = this.handleLanguageChange.bind(this);
    }
    componentDidMount(){
        API.fetchPopularRepos('all')
            .then((repos) => {
                this.setState({
                    repos,
                    loading: false,
                    language: '',
                });
            });
    }
    handleLanguageChange(language){
        this.setState({
            loading: true,
        });
        API.fetchPopularRepos(language)
            .then((repos) => {
                this.setState({
                    repos,
                    loading: false,
                    language: language === 'all' ? '' : 
                    language.substring(0,1).toUpperCase()+language.substring(1),
                });
            });
    }
    render() {
        return (
        <div>
            {this.state.loading ? (
                <Loading />
            ) : (
                <div>
                    <h1>Most Popular {this.state.language} Repos</h1>
                    <ul>
                        <li><a href = '#all' onClick={() => this.handleLanguageChange('all')}>All</a></li>
                        <li><a href = '#js' onClick={() => this.handleLanguageChange('javascript')}>JavaScript</a></li>
                        <li><a href = '#ruby' onClick={() => this.handleLanguageChange('ruby')}>Ruby</a></li>
                        <li><a href = '#python' onClick={() => this.handleLanguageChange('python')}>Python</a></li>
                        <li><a href = '#java' onClick={() => this.handleLanguageChange('java')}>Java</a></li>
                    </ul>
                    <div style={{
                                display: 'flex',
                                flexWrap: 'wrap',
                            }}>
                        {this.state.repos.map(x => {
                            return (
                            <div key={x.name}>
                                <ul>
                                    <li><a href={x.html_url}>{x.name}</a></li>
                                    <li>{`@${x.owner.login}`}</li>
                                    <li>{`${x.stargazers_count} stars`}</li>
                                </ul>
                            </div>
                            );
                        })}
                    </div>
                </div>
            )}
        </div>
        )
    }
    }
    ReactDOM.render(
    <App />,
    document.getElementById('app')
    )
</script>
</body>
</html>